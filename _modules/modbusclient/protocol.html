

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>modbusclient.protocol &mdash; modbusclient  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="modbusclient  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> modbusclient
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#default-api-template">Default API Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#asynchronous-api-template">Asynchronous API Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocol.html">The Modbus Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocol.html#protocol-implementation">Protocol Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../payload.html">User Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../payload.html#payload-types">Payload Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../payload.html#data-types">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client.html#default-client">Default Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client.html#asynchronous-client">Asynchronous Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wamp.html">WAMP Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wamp.html#base-class-for-wamp-components">Base Class for WAMP Components</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">modbusclient</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>modbusclient.protocol</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for modbusclient.protocol</h1><div class="highlight"><pre>
<span></span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="k">import</span> <span class="n">Struct</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">.error_codes</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.functions</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;modbusclient&#39;</span><span class="p">)</span>


<span class="n">MODBUS_PROTOCOL_ID</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NO_UNIT</span> <span class="o">=</span> <span class="mh">0xFF</span>
<span class="n">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">502</span>


<div class="viewcode-block" id="create_header"><a class="viewcode-back" href="../../protocol.html#modbusclient.create_header">[docs]</a><span class="k">def</span> <span class="nf">create_header</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a new header</span>

<span class="sd">    Creates a header class based on namedtuple. The namedtuple components provide</span>
<span class="sd">    a convenient access to the data stored in the header. Additionally classes</span>
<span class="sd">    created by this function contain two methods to read from and write to a</span>
<span class="sd">    binary buffer:</span>

<span class="sd">    * static method from_buffer creates an object from a binary buffer</span>
<span class="sd">    * to_buffer: writes content of the header to a binary buffer</span>
<span class="sd">    * __len__ : Provides the length of the header (excluding payload) in bytes</span>

<span class="sd">    Arguments:</span>
<span class="sd">        name (str): Name of class to create</span>
<span class="sd">        format (str): Format string. Refer to Struct documentation for format</span>
<span class="sd">            specification</span>
<span class="sd">        attrs (str): Attributes to add. Format as expected by namedtuple</span>
<span class="sd">        defaults (tuple): Default value for each attribute in attrs</span>

<span class="sd">    Return:</span>
<span class="sd">        class: Class object capable of storing the header content with additional</span>
<span class="sd">        methods to parse and serialize the stored data in binary form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Base</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new class object</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cls (class): Passed verbatim to Base.__new__</span>
<span class="sd">            *args (*args): Positional arguments passed verbatim to Base</span>
<span class="sd">            **kwargs (dict): Keyword arguments passed verbatim to Base.__new__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Base</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create message from buffer</span>

<span class="sd">        Invokes the parser on a buffer an returns the class created from the</span>
<span class="sd">        data extracted from the buffer</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cls (class): Class to create</span>
<span class="sd">            buffer (iterable): Buffer containing packed binary data</span>
<span class="sd">            offset (int): Number of bytes to skip at the begin of buffer. Defaults</span>
<span class="sd">                to zero.</span>

<span class="sd">        Return:</span>
<span class="sd">            class: Class instance created from binary data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">to_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write current message to buffer in packed binary form</span>

<span class="sd">        Invokes the internal parser to create a bytes object representing the</span>
<span class="sd">        current instance in packed binary form</span>

<span class="sd">        Return:</span>
<span class="sd">            bytes: String containing current instance in packed binary form</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get length of current message in bytes</span>

<span class="sd">        Return:</span>
<span class="sd">            int: Length of current message in packed binary form</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">size</span>

    <span class="n">msg_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="p">),</span> <span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span>
                                     <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">),</span>
                                     <span class="s2">&quot;from_buffer&quot;</span> <span class="p">:</span> <span class="n">from_buffer</span><span class="p">,</span>
                                     <span class="s2">&quot;to_buffer&quot;</span><span class="p">:</span> <span class="n">to_buffer</span><span class="p">,</span>
                                     <span class="s2">&quot;__new__&quot;</span><span class="p">:</span> <span class="n">new</span><span class="p">,</span>
                                     <span class="s2">&quot;__len__&quot;</span><span class="p">:</span> <span class="fm">__len__</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">defaults</span><span class="p">:</span>
        <span class="n">msg_type</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msg_type</span></div>


<span class="n">ApplicationProtocolHeader</span> <span class="o">=</span> <span class="n">create_header</span><span class="p">(</span><span class="s2">&quot;ApplicationProtocolHeader&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;3H2B&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;transaction protocol length unit function&quot;</span><span class="p">,</span>
                                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">))</span>
<span class="n">ApplicationProtocolHeader</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Modbus Application Protocol Header (MBAP)</span>

<span class="s2">The application header in this implementation has a size of eight bytes. It is</span>
<span class="s2">added to every request sent by a client. The server copies the MBAP into its</span>
<span class="s2">response with a modified length field.</span>

<span class="s2">Attributes:</span>
<span class="s2">    transaction (int): Transaction ID to uniquely identify the transaction in</span>
<span class="s2">        if several requests are sent in parallel</span>
<span class="s2">    protocol (int): MODBUS protocol id (always 0)</span>
<span class="s2">    length (int) Number of bytes including the unit identifier byte and all</span>
<span class="s2">       following data bytes. For a request, this has to be set by the client,</span>
<span class="s2">       while the response length is set by the server</span>
<span class="s2">    unit (int): Unit ID of the server. Defaults to NO_UNIT</span>
<span class="s2">    function (int): Function code. In the MODBUS specification this is actually</span>
<span class="s2">        part of the PDU. Since the communication is simplified by including it in</span>
<span class="s2">        the MBAP instead. In case of errors, this variable assumes the error</span>
<span class="s2">        function code (0x80).</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ReadRequest</span> <span class="o">=</span> <span class="n">create_header</span><span class="p">(</span><span class="s2">&quot;ReadRequest&quot;</span><span class="p">,</span> <span class="s2">&quot;2H&quot;</span><span class="p">,</span> <span class="s2">&quot;start count&quot;</span><span class="p">)</span>
<span class="n">ReadRequest</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Modbus Read Request Protocol Data Unit (PDU)</span>

<span class="s2">Attributes:</span>
<span class="s2">    start (int): Address of (first) register to read from</span>
<span class="s2">    count (int): Number of coils/registers to read from</span>

<span class="s2">Note:</span>
<span class="s2">    A PDU usually starts with a single byte containing the function code, which</span>
<span class="s2">    is part of the :class:`~modbusclient.ApplicationProtocolHeader` in this</span>
<span class="s2">    implementation.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">WriteRequest</span> <span class="o">=</span> <span class="n">create_header</span><span class="p">(</span><span class="s2">&quot;WriteRequest&quot;</span><span class="p">,</span> <span class="s2">&quot;2HB&quot;</span><span class="p">,</span> <span class="s2">&quot;start count size&quot;</span><span class="p">)</span>
<span class="n">WriteRequest</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Modbus Write Request Protocol Data Unit (PDU)</span>

<span class="s2">Attributes:</span>
<span class="s2">    start (int): Address of (first) register to write to</span>
<span class="s2">    count (int): Number fo coils/registers to write to</span>
<span class="s2">    size (int): Number of payload bytes to write</span>

<span class="s2">Note:</span>
<span class="s2">    A PDU usually starts with a single byte containing the function code, which</span>
<span class="s2">    is part of the :class:`~modbusclient.ApplicationProtocolHeader` in this</span>
<span class="s2">    implementation.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ReadResponse</span> <span class="o">=</span> <span class="n">create_header</span><span class="p">(</span><span class="s2">&quot;ReadResponse&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">)</span>
<span class="n">ReadResponse</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Modbus Response Protocol Data Unit (PDU)</span>

<span class="s2">Attributes:</span>
<span class="s2">    size (int): Number of payload bytes</span>

<span class="s2">Note:</span>
<span class="s2">    A PDU usually starts with a single byte containing the function code, which</span>
<span class="s2">    is part of the :class:`~modbusclient.ApplicationProtocolHeader` in this</span>
<span class="s2">    implementation.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">WriteResponse</span> <span class="o">=</span> <span class="n">create_header</span><span class="p">(</span><span class="s2">&quot;WriteResponse&quot;</span><span class="p">,</span> <span class="s2">&quot;2H&quot;</span><span class="p">,</span> <span class="s2">&quot;start count&quot;</span><span class="p">)</span>
<span class="n">WriteResponse</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Modbus Response Protocol Data Unit (PDU)</span>

<span class="s2">Attributes:</span>
<span class="s2">    start (int): Address of (first) register to write to</span>
<span class="s2">    count (int): Number of coils/registers which have been written</span>

<span class="s2">Note:</span>
<span class="s2">    A PDU usually starts with a single byte containing the function code, which</span>
<span class="s2">    is part of the :class:`~modbusclient.ApplicationProtocolHeader` in this</span>
<span class="s2">    implementation.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">Error</span> <span class="o">=</span> <span class="n">create_header</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;exception_code&quot;</span><span class="p">)</span>
<span class="n">Error</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;Modbus Error Protocol Data Unit (PDU)</span>

<span class="s2">PDU sent on errors by the server. </span>

<span class="s2">Attributes:</span>
<span class="s2">    exception_code (int): Exception code.</span>

<span class="s2">Note:</span>
<span class="s2">    A PDU usually starts with a single byte containing the function code, which</span>
<span class="s2">    is part of the :class:`~modbusclient.ApplicationProtocolHeader` in this</span>
<span class="s2">    implementation.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">REQUEST_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">READ_HOLDING_REGISTERS</span> <span class="p">:</span> <span class="n">ReadRequest</span><span class="p">,</span>
    <span class="n">READ_INPUT_REGISTERS</span> <span class="p">:</span> <span class="n">ReadRequest</span><span class="p">,</span>
    <span class="n">WRITE_MULTIPLE_REGISTERS</span> <span class="p">:</span> <span class="n">WriteRequest</span>
    <span class="c1"># TODO ...</span>
<span class="p">}</span>

<span class="n">RESPONSE_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">READ_HOLDING_REGISTERS</span> <span class="p">:</span> <span class="n">ReadResponse</span><span class="p">,</span>
    <span class="n">READ_INPUT_REGISTERS</span> <span class="p">:</span> <span class="n">ReadResponse</span><span class="p">,</span>
    <span class="n">WRITE_MULTIPLE_REGISTERS</span> <span class="p">:</span> <span class="n">WriteResponse</span>
<span class="p">}</span>


<div class="viewcode-block" id="new_request"><a class="viewcode-back" href="../../protocol.html#modbusclient.new_request">[docs]</a><span class="k">def</span> <span class="nf">new_request</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">NO_UNIT</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a request message</span>

<span class="sd">    Arguments:</span>
<span class="sd">        function (int): Function code</span>
<span class="sd">        payload (bytes): Data sent along with the request. Empty by default.</span>
<span class="sd">            Used only for writing functions.</span>
<span class="sd">        unit (int): Unit ID of device. Defaults to NO_UNIT</span>
<span class="sd">        transaction (int): Transaction ID. Defaults to 0.</span>
<span class="sd">        kwargs (dict): Keyword arguments passed verbatim to the request of</span>
<span class="sd">          the function</span>

<span class="sd">    Return:</span>
<span class="sd">        tuple(~modbusclient.ApplicationProtocolHeader, bytes): Header of the request</span>
<span class="sd">        and the request in binary form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">RequestType</span> <span class="o">=</span> <span class="n">REQUEST_TYPES</span><span class="p">[</span><span class="n">function</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unsupported Function ID&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">%s</span><span class="s2"> request&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">RequestType</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">RequestType</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">+</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">ApplicationProtocolHeader</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span>
                                       <span class="n">protocol</span><span class="o">=</span><span class="n">MODBUS_PROTOCOL_ID</span><span class="p">,</span>
                                       <span class="n">length</span><span class="o">=</span><span class="n">nbytes</span><span class="p">,</span>
                                       <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                                       <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">header</span><span class="o">.</span><span class="n">to_buffer</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">to_buffer</span><span class="p">(),</span> <span class="n">payload</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">buffer</span></div>


<div class="viewcode-block" id="parse_response_header"><a class="viewcode-back" href="../../protocol.html#modbusclient.parse_response_header">[docs]</a><span class="k">def</span> <span class="nf">parse_response_header</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse response header</span>

<span class="sd">    Arguments:</span>
<span class="sd">        buffer (bytes): Buffer containing the Application protocol header</span>

<span class="sd">    Return:</span>
<span class="sd">        ~modbusclient.ApplicationProtocolHeader: Application protocol header</span>

<span class="sd">    Raise:</span>
<span class="sd">        RuntimeError: if header.protocol does not match MODBUS_PROTOCOL_ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parsing Application Protocol header ...&quot;</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">ApplicationProtocolHeader</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">MODBUS_PROTOCOL_ID</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid protocol ID&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">header</span></div>


<div class="viewcode-block" id="parse_response_body"><a class="viewcode-back" href="../../protocol.html#modbusclient.parse_response_body">[docs]</a><span class="k">def</span> <span class="nf">parse_response_body</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse response body</span>

<span class="sd">    Arguments:</span>
<span class="sd">        header (:class:`~modbusclient.ApplicationProtocolHeader`): The header. See</span>
<span class="sd">            e.g. :func:`parse_response_header`</span>
<span class="sd">        buffer (bytes): Buffer containing the response body after the header</span>

<span class="sd">    Return:</span>
<span class="sd">        tuple(object, int): Payload and error code</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parsing response body ...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">function</span> <span class="o">&gt;</span> <span class="n">ERROR_FLAG</span><span class="p">:</span>  <span class="c1"># second byte = function code</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Error</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">err_code</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exception_code</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response_type</span> <span class="o">=</span> <span class="n">RESPONSE_TYPES</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">function</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">response_type</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">):]</span>

        <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">err_code</span> <span class="o">=</span> <span class="n">MESSAGE_SIZE_ERROR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_code</span> <span class="o">=</span> <span class="n">NO_ERROR</span>
    <span class="k">return</span> <span class="n">payload</span><span class="p">,</span> <span class="n">err_code</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, claashk.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>